<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Créer l&#39;API REST | Création d&#39;une application mobile</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../backend/deploy.html" />
    
    
    <link rel="prev" href="../backend/index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="3.1"
        data-chapter-title="Créer l&#39;API REST"
        data-filepath="backend/restapi.md"
        data-basepath=".."
        data-revision="Fri Jan 29 2016 09:00:08 GMT-0400 (AST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="prerequis.html">
            
                
                    <a href="../prerequis.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Prérequis
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="mobile/index.html">
            
                
                    <a href="../mobile/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Application mobile
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="mobile/mac.html">
            
                
                    <a href="../mobile/mac.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Installation sous Mac
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="mobile/windows.html">
            
                
                    <a href="../mobile/windows.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Installation sous windows
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="mobile/creer.html">
            
                
                    <a href="../mobile/creer.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Créer l&#39;application
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="mobile/deploy.html">
            
                
                    <a href="../mobile/deploy.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Déployer l&#39;application
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="backend/index.html">
            
                
                    <a href="../backend/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Backend
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="3.1" data-path="backend/restapi.html">
            
                
                    <a href="../backend/restapi.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Créer l&#39;API REST
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="backend/deploy.html">
            
                
                    <a href="../backend/deploy.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Créer la ou les base(s) de données
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="backend/mobile-link.html">
            
                
                    <a href="../backend/mobile-link.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Appeler votre API depuis votre appli mobile
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="plugins.html">
            
                
                    <a href="../plugins.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Plugins
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Création d&#39;une application mobile</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="cr&#xE9;er-lapi-rest">Cr&#xE9;er l&apos;API REST</h1>
<h2 id="installer-strongloop">Installer Strongloop</h2>
<p>Installer strongloop:</p>
<pre><code>$ npm install strongloop -g
</code></pre><p>Cr&#xE9;er l&apos;application:</p>
<pre><code>$ slc loopback
</code></pre><h2 id="configurer-le-login-facebook">Configurer le login facebook</h2>
<p>Pour permettre &#xE0; vos utilisateurs de se logguer avec des comptes tiers, il faut installer 2 modules suppl&#xE9;mentaires:</p>
<pre><code>$ npm install loopback-component-passport --save
$ npm install passport-facebook --save
</code></pre><p>Ouvrez le fichier server/model-config.json, ajouter ./node_modules/loopback-component-passport/lib/models &#xE0; la liste des source puis ajoutez les modules UserCredential et UserIdentity:</p>
<pre><code>&quot;UserCredential&quot;: {
  &quot;dataSource&quot;: &quot;db&quot;,
  &quot;public&quot;: true
},
&quot;UserIdentity&quot;: {
  &quot;dataSource&quot;: &quot;db&quot;,
  &quot;public&quot;: true
}
</code></pre><p>Configurer votre serveur pour permettre vos logins Facebook.</p>
<p>Cr&#xE9;er le script boot facebook-oauth.js dans server/boot:</p>
<pre><code>// Make sure to also put this in `server/server.js`
var PassportConfigurator =
  require(&apos;loopback-component-passport&apos;).PassportConfigurator;

// Include this in your &apos;facebook-oauth.js&apos; boot script in `server/boot`.
var passportConfigurator = new PassportConfigurator(app);

passportConfigurator.init();
passportConfigurator.setupModels({
  userModel: app.models.User,
  userIdentityModel: app.models.UserIdentity,
  userCredentialModel: app.models.UserCredential
});
passportConfigurator.configureProvider(&apos;facebook-login&apos;,
  require(&apos;../providers.json&apos;)[&apos;facebook-login&apos;]);
</code></pre><p>Ajouter la ligne suivante dans server/server.js:</p>
<pre><code>var PassportConfigurator =
  require(&apos;loopback-component-passport&apos;).PassportConfigurator;
</code></pre><p>Cr&#xE9;er le fichier providers.json sous server:</p>
<pre><code>{
  &quot;facebook-login&quot;: {
    &quot;provider&quot;: &quot;facebook&quot;,
    &quot;module&quot;: &quot;passport-facebook&quot;,
    &quot;clientID&quot;: &quot;919651901409502&quot;,
    &quot;clientSecret&quot;: &quot;5ca481b467aa7f80c24702f093e64417&quot;,
    &quot;callbackURL&quot;: &quot;http://localhost:3000/auth/facebook/callback&quot;,
    &quot;authPath&quot;: &quot;/auth/facebook&quot;,
    &quot;callbackPath&quot;: &quot;/auth/facebook/callback&quot;,
    &quot;successRedirect&quot;: &quot;/api/Users/me&quot;,
    &quot;scope&quot;: [&quot;public_profile&quot;]
  }
}
</code></pre><p>NB: Les id propos&#xE9;es sont pour une application de test. Il vous faudra cr&#xE9;er votre propre application facebook.</p>
<h2 id="obtenir-lutilisateur-connect&#xE9;">Obtenir l&apos;utilisateur connect&#xE9;</h2>
<p>Pour tracker l&apos;utilisateur connect&#xE9;, vous aurez besoin de stocker les sessions et de parser les cookies.</p>
<pre><code>$ npm install express-session --save
$ npm install cookie-parser --save
</code></pre><p>Pluguez les middleware install&#xE9;s &#xE0; votre API REST en ajoutant le code suivant dans le fichier server/middleware.json.</p>
<pre><code>&quot;session:before&quot;: {
  &quot;cookie-parser&quot;: { &quot;params&quot;: &quot;test secret&quot; }
},
&quot;session&quot;: {
  &quot;express-session&quot;: {
    &quot;params&quot;: {
      &quot;secret&quot;: &quot;other test secret&quot;,
      &quot;saveUninitialized&quot;: true,
      &quot;resave&quot;: true
    }
  }
}
</code></pre><p>Ajouter le middleware &#x2018;auth&#x2019; pour transformer /me en l&apos;ID de l&apos;utilisateur connect&#xE9;. Pour cela ajouter le code suivant au script boot server/boot/authentication.js.</p>
<pre><code>server.middleware(&apos;auth&apos;, loopback.token({
  model: server.models.accessToken,
  currentUserLiteral: &apos;me&apos;
}));
</code></pre><h2 id="configurer-vos-mod&#xE8;les">Configurer vos mod&#xE8;les</h2>
<p>Cr&#xE9;er une nouvelle source de donn&#xE9;es qui va &#xEA;tre connect&#xE9;e &#xE0; votre base de donn&#xE9;es. </p>
<pre><code>$ slc loopback:datasource [ds_name]
</code></pre><p>Choisissez le connector MySql.</p>
<p>Cr&#xE9;er un nouveau mod&#xE8;le et suivez les indications:</p>
<pre><code>$ slc loopback:model &lt;model_name&gt;
</code></pre><p>Vous serez amen&#xE9; &#xE0; pr&#xE9;ciser:</p>
<ul>
<li>La source de donn&#xE9;es &#xE0; laquelle votre mod&#xE8;le doit &#xEA;tre connect&#xE9;. Par d&#xE9;faut, il n&apos;y en a qu&apos;une (la in-memory nomm&#xE9;e &quot;db&quot;). Si vous avez cr&#xE9;&#xE9; une autre source de donn&#xE9;es comme indiqu&#xE9; plus haut, elle appara&#xEE;tra &#xE9;galement.</li>
<li>Le mod&#xE8;le de la classe de base, utilisez PersistedModel.</li>
<li>D&apos;exposez votre mod&#xE8;le &#xE0; l&apos;API REST - choisissez oui. </li>
<li>Un nom &#xE0; utiliser au pluriel.</li>
<li>Les propri&#xE9;t&#xE9;s de votre mod&#xE8;le.</li>
</ul>
<p>Un nouveau fichier est cr&#xE9;&#xE9; dans common/models.</p>
<p>Si vous voulez d&#xE9;finir une relation entre votre nouveau mod&#xE8;le et un User, vous devez d&#xE9;clarer cette ralation dans le fichier server/server.js.</p>
<pre><code>var User = app.models.User;
User.hasMany(app.models.&lt;model_name&gt;, { as: &apos;&lt;model_name&gt;s&apos;, foreignKey: &apos;userId&apos; });
</code></pre><p>Maintenant, votre mod&#xE8;le a un champ &apos;userId&apos; qui traque &#xE0; quel utilisateur l&apos;enregistrement appartient.</p>
<p>Il faut maintenant configurer les permissions. Un utilisateur ne doit pouvoir acc&#xE9;der qu&apos;&#xE0; ses donn&#xE9;es, un utilisateur loggu&#xE9; doit &#xEA;tre capable de cr&#xE9;er un enregistrement.</p>
<p>Utiliser la commande slc loopback:acl pour cr&#xE9;er les permissions. </p>
<pre><code>$ slc loopback:acl
? Select the model to apply the ACL entry to: &lt;model_name&gt;
? Select the ACL scope: All methods and properties
? Select the access type: All (match all types)
? Select the role: All users
? Select the permission to apply: Explicitly deny access
$ slc loopback:acl
? Select the model to apply the ACL entry to: &lt;model_name&gt;
? Select the ACL scope: All methods and properties
? Select the access type: All (match all types)
? Select the role: The user owning the object
? Select the permission to apply: Explicitly grant access
$ slc loopback:acl
? Select the model to apply the ACL entry to: &lt;model_name&gt;
? Select the ACL scope: A single method
? Enter the method name: create
? Select the role: Any authenticated user
? Select the permission to apply: Explicitly grant access
</code></pre><p>On a ainsi d&#xE9;finit 3 r&#xE8;gles de controle d&apos;acc&#xE8;s pour notre mod&#xE8;le:</p>
<ul>
<li>Par d&#xE9;faut, toutes les op&#xE9;rations sur notre mod&#xE8;le sont refus&#xE9;es.</li>
<li>Un utilisateur a tous les droits sur les donn&#xE9;es qui lui appartiennent.</li>
<li>Un utilisateur loggu&#xE9; peut cr&#xE9;er un nouvel enregistrement.</li>
</ul>
<p>Le fichier de votre mod&#xE8;le dans common/models est modifi&#xE9; en cons&#xE9;quence.</p>
<p>Il faut &#xE9;galement ajouter un ACL au mod&#xE8;le User &#xE9;galement. Cr&#xE9;er le script de boot server/boot/user-permissions.js:</p>
<pre><code>module.exports = function(app) {
  var User = app.models.User;
  var ACL = app.models.ACL;
  User.hasMany(app.models.&lt;model_name&gt;, { as: &apos;times&apos;, foreignKey: &apos;userId&apos; });
  ACL.create({
    accessType: ACL.ALL,
    permission: ACL.ALLOW,
    principalType: ACL.ROLE,
    principalId: &apos;$owner&apos;,
    model: &apos;User&apos;,
    property: &apos;__get__&lt;model_name&gt;s&apos;
  });
};
</code></pre><p>Enfin, pour &#xE9;viter qu&apos;un utilisateur ne cr&#xE9;e un enregistrement pour un autre utilisateur, cr&#xE9;er le fichier common/model/<model_name>.js:</model_name></p>
<pre><code>app.models.&lt;model_name&gt;.beforeRemote(&apos;create&apos;, function(ctx, modelInstance, next) {
  ctx.args.data.userId = ctx.req.accessToken.userId;
  next();
});
</code></pre>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../backend/index.html" class="navigation navigation-prev " aria-label="Previous page: Backend"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../backend/deploy.html" class="navigation navigation-next " aria-label="Next page: Créer la ou les base(s) de données"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
